#include "model.h"

#include "nnmath.h"

double _INTERCEPTS[20] = {0.3265093287272763, 0.31167958154554654, 0.8722894626788409, 0.30946054918616306, 0.3117871289237435, 1.2384655704933867, -0.021137984562401638, 0.9047021748415387, -0.3653279780656102, -0.3205702171694995, 0.749346155992027, 0.03809005558115499, -0.5707269340865848, 1.3303958615119316, -0.25269832058933406, -0.24281717279706846, 0.027638342498158528, 0.14945743647576676, -0.8493358716073757, 0.3795586534771048};

double _COEFS[120] = {-0.39039344650555957, 0.9552664354849529, 0.3531786451348418, -1.3793958320327482, -0.7483046880458547, -0.9902442520438411, 1.0476782229727357, 1.4359175363917926, 0.37722227141588177, 0.4585021881904902, -0.5959724739355391, -0.41179319955783333, -0.31329320778100256, 1.1894619590426831, 0.05078429719996783, -1.9099040224211565, 0.8113226170561562, -0.15795285004616916, 0.125992591961721, 0.5012879011007944, -0.8228964005163492, -0.5077422776326833, -0.47878076838157035, 0.17584592647266611, -0.5731305617829332, 0.6515618985798922, 0.5921968690210117, -0.5279106827876754, -1.24322965375129, -1.075107699931881, -9.107137539031175e-11, -0.03354770102711963, 0.27590034751454484, -0.030788159326569437, 1.0971680164902708, 0.32769652936636673, -0.053117238231905554, 0.5527530398065931, -1.1904478364450756e-16, 7.773712319943506e-05, -0.8627026612892096, -0.11973811818872139, 0.9973153811241052, -0.2906180356095413, 0.7370986635505771, 0.593290035708473, 2.2982088578668313e-23, 0.7760666372618591, -0.900435559546433, 0.6686005074992524, 0.8746023103193556, -0.4337960386096229, 0.4864030687573876, -0.4300858783430402, 4.1149165247095104e-26, -1.3921291775013156, -1.010594979612696, 0.030720344450018706, -0.4231914491242104, 0.41231556646418066, 0.501424421253213, -0.8879230708479582, -5.1961188014456245e-23, -0.13358810233945725, -0.16703195100343474, 1.0497672372182243, -0.5639087849647683, -0.04900230481001064, 0.7837850525794631, -0.06216383263561365, -1.8005991780052184e-68, 0.213685215261135, -0.3003612836193092, 0.5551099552499787, -0.07749417193873881, 0.2146521614277152, -1.0037054734987647, -1.8143851543652254, -0.49386051459478864, 0.703391707909412, -0.10133132839257576, 0.027969043860989265, -1.139682239231894, 0.22397663963454628, 0.8368003850707861, 0.2731117732950914, -1.5572086323389638, -0.20990657034842367, 0.5917163418579615, 0.3762871789803455, 0.699711632936098, 0.17474251778823366, 0.16282015470871117, 0.048244948190935645, -0.45137596840188426, -1.1282656115534317, -0.8247200615404575, 0.10618255040387972, 0.845911299477048, 1.1571939472551591, -0.13134268332389606, -0.6929285248922072, -0.3666535329138985, 0.4166398916046602, -1.3380386828715922, 0.2345698750459497, 0.29155914558473783, -1.6680431487098042, 9.29727731575296e-76, -4.117639661186631e-11, 2.964587384715391e-10, 1.2398852472687078e-29, 3.743222730297655e-24, -4.731423733920783e-16, -0.9004423496805616, -0.706625778470987, 1.3773036116639363, -0.6665205257869788, 0.25378234181672543, 0.8484579882521027};

size_t LAYER_SIZES[NEURAL_NET_NLAYERS] = {4, 6, 8, 6};

Matrix2D* INTERCEPTS[NEURAL_NET_NLAYERS - 1];
Matrix2D* COEFS[NEURAL_NET_NLAYERS - 1];

bool params_initialized = false;


void nn_init_param_matrices(void) {
    if (params_initialized) {  
        // Do nothing
    } else {
        size_t intercept_start = 0;
        size_t coef_start = 0;
        for (size_t i = 0; i < NEURAL_NET_NLAYERS - 1; i++) {
            INTERCEPTS[i] = matrix2d_from_static_arr(&_INTERCEPTS[intercept_start], 1, LAYER_SIZES[i+1]);
            intercept_start += LAYER_SIZES[i+1];
            
            COEFS[i] = matrix2d_from_static_arr(&_COEFS[coef_start], LAYER_SIZES[i], LAYER_SIZES[i+1]);
            coef_start += (LAYER_SIZES[i] * LAYER_SIZES[i+1]);
        }
        params_initialized = true;
    }
}

Matrix2D* nn_predict(Matrix2D* x) {
    Matrix2D* prev;
    int i;
    
    // Make sure parameters are available as Matrix2d's
    nn_init_param_matrices();
    
    for (i = 0; i < (NEURAL_NET_NLAYERS - 1); i++) {
        prev = x; // Save previous matrix to destroy later
        
        x = matmul(x, COEFS[i]);
        // Hidden layer(s)
        if (i < NEURAL_NET_NLAYERS - 2){
            for (int j = 0; j < x->shape[1]; j++) {
                x->i[0][j] = relu(x->i[0][j] + INTERCEPTS[i]->i[0][j]);
            }
        // Output layer
        } else {
            for (int j = 0; j < x->shape[1]; j++) {
                x->i[0][j] = x->i[0][j] + INTERCEPTS[i]->i[0][j];
            }
            softmax(x);
        }
        
        if (i > 0) { destroy_matrix2d(prev); }
    }
    
    return x;
}
